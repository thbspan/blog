# 事务隔离级别

## 事务的特征（ACID）

- 原子性（Atomicity）
- 一致性（Consistency）
- 隔离性（Isolation）
- 持久性（Durability）

下面会详细介绍隔离性

## 事务隔离要解决的问题

- 脏读
  - 读到了其他事务未提交的数据，未提交意味着数据可能会回滚，也就是说数据可能不会存储到数据库中
- 可重复读
  - 在一个事务内，最开始读到的数据和事务结束前任意时刻读到的同一批次数据都是一致的。通常针对数据**更新**操作（**也就是针对已有行的更改操作，事务结束前读到的数据是一致的；对于新插入的行记录，就没有那么幸运了**）
- 不可重复读
  - 对比可重复读，不可重复读指在同一个事务中，不同的时刻读到的同一批次的数据可能是不一样的，可能会受到其他事务的影响，比如其他事务修改了这批数据并且提交了。通常针对数据**更新**操作
- 幻读
  - 针对数据**插入**操作来说的。假设事务A对某些行的内容做了更改，但是还未提交，此时事务B插入与事务A更改前的记录相同的记录行，并在事务A提交之前先提交了，而这时，在事务A中查询时，会发现好像刚刚的更改对于某些数据未起到作用，但其实是事务B刚插入进来的，让用户感觉很魔幻，感觉出现了幻觉，这就叫幻读

## SQL标准定义的四种隔离级别

1. 读未提交（READ UNCOMMITTED）
2. 读提交（READ COMMIT）
3. 可重复读（REPEATABLE READ）
4. 串行化（SERIALIZABLE）

这四种隔离级别，**MySQL 全都支持**。从上到下，隔离强度逐渐增强，性能逐渐变差。**可重复读**是MySQL的默认级别（**MySQL已经在可重复读的隔离级别下解决了幻读问题**）。

下面展示四种隔离级别对这三个问题的解决程度

| 隔离级别 | 脏读   | 不可重复读 | 幻读   |
| :------- | ------ | ---------- | ------ |
| 读未提交 | 可能   | 可能       | 可能   |
| 读提交   | 不可能 | 可能       | 可能   |
| 可重复读 | 不可能 | 不可能     | 可能   |
| 串行化   | 不可能 | 不可能     | 不可能 |

由上面的图表可以看出，**只有串行化可以解决全部这三个问题，其他的三个隔离级别都有缺陷**。

## MySQL中查看隔离级别

``` sql
-- 5.7.20之前
SELECT @@tx_isolation
show variables like 'tx_isolation'

-- 5.7.20之后增加，上面的命令也支持
show variables like 'transaction_isolation'
SELECT @@transaction_isolation

```

## MySQL中修改事务的隔离级别

修改隔离级别的语句：

``` sql
-- set [作用域] transaction isolation level [事务隔离级别]
SET [SESSION|GLOBAL] TRANSACTION ISOLATION LEVEL [READ UNCOMMITTED | READ COMMITTED|REPEATABLE READ | SERIALIZIABLE]
```

