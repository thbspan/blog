# redis 延时队列

## 作为消息队列

### 特点

- 没有非常多的高级特性
- 没有ack保证

## 异步消息队列实现

使用list数据结构，使用`rpush/lpush`入队，`rpop/lpop`出队

`blpop/brpop`阻塞读可以解决队列为空，获取到空元素的问题

**注意：**

`blpop/brpop`阻塞读时，如果线程一直阻塞，edis 的客户端连接就成了闲置连接，闲置过久，服务器一般会主动断开连接，减少闲置资源占用。这个时候`blpop/brpop`会抛出异常来。

所以编写客户端消费者的时候要小心，注意捕获异常，还要重试。



## 延时队列

延时队列可以通过 Redis 的 zset(有序列表) 来实现。我们将消息序列化成一个字符串作为 zset 的`value`，这个消息的到期处理时间作为`score`，然后用多个线程轮询 zset 获取到期的任务进行处理，多个线程是为了保障可用性，万一挂了一个线程还有其它线程可以继续处理。因为有多个线程，所以需要考虑并发争抢任务，确保任务不能被多次执行。



